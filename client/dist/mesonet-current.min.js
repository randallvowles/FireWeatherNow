/*
mesonet-0.5.3.js
(C) 2016 MesoWest/SynopticLabs. All rights reserved.
*/
function mesonet(){"use strict";function a(a){var b=[];for(var c in a)b.push(c);return b}function b(){function a(){var a=$.Deferred();return a.resolve(),a.promise()}var b,g=$.Deferred();if("TimeSeries"===h.config.fetch.service)b=e();else if("Latest"===h.config.fetch.service)b=_fetchLatest();else{if("Metadata"!==h.config.fetch.service)return 1;b=c(),h.config.fetch.qcTypes=!1}var i;i=h.config.fetch.qcTypes?d():a();var j;return j=h.config.fetch.longNames?f():a(),$.when(b,i,j).done(function(){g.resolve()}),g.promise()}function c(){function b(){var a;void 0!==j.dev?(a="http://dev2.mesowest.net:"+j.dev+"/",console.log("fetchStationMetadata -> Dev Port: "+j.dev)):a="http://api.mesowest.net/v2/";var b=a+"stations/metadata?callback=?";$.ajax({url:b,type:"GET",dataType:"JSON",data:h.response.queryParameters,complete:function(a){d.notify(this.url),c(a),d.resolve()}})}function c(b){var c={};try{c=b.responseJSON}catch(a){console.log("fetchStationMetadata.er2")}if(delete h.response.qcEnabled,delete h.response.qcFlags,delete h.response.qcFlagNames,delete h.response.qcLongNames,delete h.response.summary,delete h.response.units,h.response.status={},h.response.mnetID={},1==c.SUMMARY.RESPONSE_CODE)for(var d=0;d<c.STATION.length;d++)h.response.tableOfContents[c.STATION[d].STID]=d,h.response.sensorStack[d]=a(c.STATION[d].SENSOR_VARIABLES),h.response.station[d]=c.STATION[d],h.response.status[c.STATION[d].STID]=c.STATION[d].STATUS,h.response.mnetID[c.STATION[d].STID]=c.STATION[d].MNET_ID;else console.log("fetchStationMetadata.er3"),console.log(c.SUMMARY)}var d=$.Deferred();try{b()}catch(a){console.log("fetchStationMetadata\n"+this.url+"\ner1")}return d.promise()}function d(){function a(){var a;void 0!==j.dev?(a="http://dev2.mesowest.net:"+j.dev+"/",console.log("fetchQcTypes -> Dev Port: "+j.dev)):a="http://api.mesowest.net/v2/";var d=a+"qctypes?callback=?",e={token:h.config.fetch.apiToken};$.ajax({url:d,type:"GET",dataType:"JSON",data:e,complete:function(a){b(a),c.resolve()}})}function b(a){var b=a.responseJSON;1==b.SUMMARY.RESPONSE_CODE&&(h.response.qcLongNames=b.QCTYPES)}var c=$.Deferred();try{a()}catch(a){return alert("fetchQcTypes.callAPI\n\n",this.url),!1}return c.promise()}function e(){function b(){var a;void 0!==j.dev?(a="http://dev2.mesowest.net:"+j.dev+"/",console.log("fetchTimeSeries -> Dev Port: "+j.dev)):a="http://api.mesowest.net/v2/";var b=a+"stations/timeseries?callback=?";$.ajax({url:b,type:"GET",dataType:"JSON",data:h.response.queryParameters,complete:function(a){d.notify(this.url),c(a),d.resolve()}})}function c(b){var c={};try{c=b.responseJSON}catch(a){console.log("fetchTimeSeries.er2")}if(h.response.qcEnabled.push(!1),1==c.SUMMARY.RESPONSE_CODE)for(var d=0;d<c.STATION.length;d++)h.response.sensorStack[d]=a(c.STATION[d].OBSERVATIONS),h.response.qcEnabled[d]=c.STATION[d].QC_FLAGGED,h.response.station[d]=c.STATION[d],h.response.units=c.UNITS,h.response.summary=c.SUMMARY,h.response.tableOfContents[c.STATION[d].STID]=d,h.response.qcEnabled&&(h.response.qcFlagNames[d]=a(c.STATION[d].QC),h.response.qcFlags[d]=c.STATION[d].QC);else console.log("fetchTimeSeries.er3"),console.log(c.SUMMARY)}var d=$.Deferred();try{b()}catch(a){console.log("fetchTimeSeries.er1")}return d.promise()}function f(){function a(){var a;void 0!==j.dev?(a="http://dev2.mesowest.net:"+j.dev+"/",console.log("fetchVariableNames -> Dev Port: "+j.dev)):a="http://api.mesowest.net/v2/";var d=a+"variables?callback=?",e={token:h.config.fetch.apiToken};$.ajax({url:d,type:"GET",dataType:"JSON",data:e,complete:function(a){b(a),c.resolve()}})}function b(a){var b=a.responseJSON;1==b.SUMMARY.RESPONSE_CODE&&(h.response.sensorLongNames=b.VARIABLES)}var c=$.Deferred();try{a()}catch(a){return alert("fetchVariableNames.er1\n\n",h.url),1}return c.promise()}function g(){function b(a){return h.response.qcLongNames.filter(function(b){return b.ID==a})}var c={},d=0;d="undefined"!=typeof h.config.table.stid?h.response.tableOfContents[h.config.table.stid.toUpperCase()]:0,c=h.response.station[d].OBSERVATIONS;var e=!1,f=!1,g=!1,i=!1,j=!1;"undefined"!=typeof h.config.table.detached?(h.config.table.detached&&"undefined"!=typeof h.config.table.detached&&(e=!0),h.config.table.detached||"undefined"==typeof h.config.table.detached||(f=!0),null!==h.response.qcLongNames[0]&&(g=!0),void 0!==h.response.qcFlags[d]&&(i=!0),"inline"===h.config.table.detached&&(j=!0)):f=!0;var k=0,l=0,m=0,n=0,o=0;if(h.config.table.descend){var p=a(c);for(n=p.length,k=0;k<n;k++)c[p[k]]=c[p[k]].reverse()}var q=["date_time"],r=["Time"],s=[""];for(n=h.response.sensorLongNames.length,k=0;k<n;k++)for(o=a(h.response.station[d].SENSOR_VARIABLES).length,l=0;l<o;l++)try{var t=a(h.response.sensorLongNames[k])[0],u=a(h.response.station[d].SENSOR_VARIABLES)[l];if(t===u){var v,w=a(h.response.station[d].SENSOR_VARIABLES[u]).length;for(m=0;m<w;m++){var x=[],y=[];if(w>1){for(m=0;m<w;m++)if(x.push(a(h.response.station[d].SENSOR_VARIABLES[u])[m]),v=a(h.response.station[d].SENSOR_VARIABLES)[l],y.push(h.response.sensorLongNames[k][v].long_name+" ("+(m+1)+")"),s.push(h.response.units[v]),m+1==w){x.sort();var z=0;for(z=0;z<w;z++)q.push(x[z]),r.push(y[z]);x=[],y=[]}}else q.push(a(h.response.station[d].SENSOR_VARIABLES[u])[m]),v=a(h.response.station[d].SENSOR_VARIABLES)[l],r.push(h.response.sensorLongNames[k][v].long_name),s.push(h.response.units[v])}}}catch(a){console.log("Rut rho! makeTimeSeriesTable.er1")}var A=[],B=document.createElement("TABLE");for(B.setAttribute("id",h.config.table.tableID),B.setAttribute("class","table table-responsive"),document.getElementById(h.config.table.tableID+"-container").appendChild(B),n=c.date_time.length+1,k=0;k<n;k++){var C=document.createElement("TR");C.setAttribute("id","time-row-"+k),document.getElementById(h.config.table.tableID).appendChild(C);var D,E;if(o=q.length,0===k){for(l=0;l<o;l++)D=document.createElement("TH"),E=document.createTextNode(r[l]),D.appendChild(E),C.appendChild(D);document.getElementById("time-row-"+k).appendChild(D)}else for(l=0;l<o;l++){if(D=document.createElement("TD"),E=document.createTextNode(""),i&&q[l]in h.response.qcFlags[d]&&!f&&null!==h.response.qcFlags[d][q[l]][k-1])if(g&&!f&&j)D.setAttribute("class",h.config.table.qcFailClass),E.nodeValue=c[q[l]][k-1]+" ("+h.response.qcLongNames[h.response.qcFlags[d][q[l]][k-1]].NAME+")";else for(null===c[q[l]][k-1]?(D.setAttribute("class",h.config.table.qcFailClass),E.nodeValue=""):(D.setAttribute("class",h.config.table.qcFailClass),E.nodeValue=c[q[l]][k-1]+" ("+h.response.qcFlags[d][q[l]][k-1]+")"),m=0;m<h.response.qcFlags[d][q[l]][k-1].length;m++)A.indexOf(h.response.qcFlags[d][q[l]][k-1][m])==-1&&A.push(h.response.qcFlags[d][q[l]][k-1][m]);else null===c[q[l]][k-1]?E.nodeValue="":E.nodeValue=c[q[l]][k-1];D.appendChild(E),document.getElementById("time-row-"+k).appendChild(D)}}if(h.config.table.showUnits){var F=B.insertRow(1);for(k=0,n=q.length,k=0;k<n;k++){var G=F.insertCell(k);G.innerHTML=s[k]}}var H;if(A.length>0){document.getElementById(h.config.table.detached);for(k=0;k<A.length;k++){var I=document.createElement("LI");H=b(A[k]);var J=document.createTextNode(A[k]+" : "+H[0].NAME);I.appendChild(J),document.getElementById(h.config.table.detached).appendChild(I)}}return 0}var h=this;this.response={tableOfContents:{},station:[],sensorStack:[],sensorLongNames:{},summary:{},units:{},qcFlags:{},qcFlagNames:[],qcEnabled:[],qcLongNames:{},queryParameters:{}},this.config={fetch:{service:"TimeSeries",apiToken:"not-set",longNames:!0,qcTypes:!0,notify:!1},table:{qcFailClass:"qc-fail",htmlID:"tabular-data",detached:"qc-codes",showUnits:!0,descend:!0},csv:{}};var i,j=function(){var a,b={},c=window.location.search.substring(1).split("&"),d=c.length;if(1===window.location.search.substring(1).split("="))return"undefined";for(var e=0;e<d;e++)a=c[e].split("="),"undefined"==typeof b[a[0]]&&(b[a[0]]=decodeURIComponent(a[1]));return b}();mesonet.prototype.async=function(){return $.when(i).done(function(){}),i},mesonet.prototype.configureTable=function(b){var c=0;for(c=0;c<a(b).length;c++)this.config.table[a(b)[c]]=b[a(b)[c]]},mesonet.prototype.fetch=function(c){var d,e=0;if(0===c)for(d=a(j),e=0;e<d.length;e++)this.response.queryParameters[d[e]]=j[d[e]];else for(d=a(c),e=0;e<d.length;e++)this.response.queryParameters[d[e]]=c[d[e]];return i=b(),$.when(i).done(function(){}),this.response},mesonet.prototype.setApiToken=function(a){return this.config.fetch.apiToken=a,this.response.queryParameters.token=a,0},mesonet.prototype.setService=function(a){try{this.config.fetch.service=a}catch(a){return 1}return 0},mesonet.prototype.showResponse=function(){return $.when(i).done(function(){console.log(h.response)}),0},mesonet.prototype.table=function(){return $.when(i).done(function(){g()}),0},mesonet.prototype.windowArgs=function(){return j}}